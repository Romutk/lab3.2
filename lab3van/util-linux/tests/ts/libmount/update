#!/bin/bash

# Copyright (C) 2010 Karel Zak <kzak@redhat.com>

<<<<<<< HEAD
TS_TOPDIR="$(dirname $0)/../.."
=======
TS_TOPDIR="${0%/*}/../.."
>>>>>>> master-vanilla
TS_DESC="tab update"

. $TS_TOPDIR/functions.sh
ts_init "$*"
ts_skip_nonroot

TESTPROG="$TS_HELPER_LIBMOUNT_UPDATE"

[ -x $TESTPROG ] || ts_skip "test not compiled"

# IMPORTANT notes:
#
#  - the $TS_OUTPUT variable is between ts_init_subtest and ts_finalize_subtest
#    redefined to subtest specific namespace -- it means that $TS_OUTPUT is a
#    different file within a subtest.
#
#  - all this test uses global $TS_OUTPUT.{mtab,mountinfo}


#
# Traditional /etc/mtab
#
export LIBMOUNT_MTAB=$TS_OUTPUT.mtab
rm -f $LIBMOUNT_MTAB
> $LIBMOUNT_MTAB

ts_init_subtest "mtab-mount"
<<<<<<< HEAD
$TESTPROG --add /dev/sda1 /mnt/foo ext3 "rw,bbb,ccc,fff=FFF,ddd,noexec"
$TESTPROG --add /dev/sdb1 /mnt/bar ext3 "gg=G,ffff=f,ro,noatime"
$TESTPROG --add /dev/sda2 /mnt/bar ext3 "rw,noatime"
$TESTPROG --add /dev/sda1 /mnt/gogo ext3 "rw,noatime,nosuid"
$TESTPROG --add none /proc proc defaults
=======
ts_valgrind $TESTPROG --add /dev/sda1 /mnt/foo ext3 "rw,bbb,ccc,fff=FFF,ddd,noexec"
ts_valgrind $TESTPROG --add /dev/sdb1 /mnt/bar ext3 "gg=G,ffff=f,ro,noatime"
ts_valgrind $TESTPROG --add /dev/sda2 /mnt/bar ext3 "rw,noatime"
ts_valgrind $TESTPROG --add /dev/sda1 /mnt/gogo ext3 "rw,noatime,nosuid"
ts_valgrind $TESTPROG --add none /proc proc defaults
>>>>>>> master-vanilla
cp $LIBMOUNT_MTAB $TS_OUTPUT	# save the mtab aside
ts_finalize_subtest		# checks the mtab

ts_init_subtest "mtab-move"
<<<<<<< HEAD
$TESTPROG --move /mnt/foo /mnt/newfoo
$TESTPROG --move /mnt/bar /mnt/newbar
=======
ts_valgrind $TESTPROG --move /mnt/foo /mnt/newfoo
ts_valgrind $TESTPROG --move /mnt/bar /mnt/newbar
>>>>>>> master-vanilla
cp $LIBMOUNT_MTAB $TS_OUTPUT	# save the mtab aside
ts_finalize_subtest		# checks the mtab

ts_init_subtest "mtab-remount"
<<<<<<< HEAD
$TESTPROG --remount /mnt/newfoo "ro,noatime"
$TESTPROG --remount /mnt/bar "rw,atime,nosuid"
=======
ts_valgrind $TESTPROG --remount /mnt/newfoo "ro,noatime"
ts_valgrind $TESTPROG --remount /mnt/bar "rw,atime,nosuid"
>>>>>>> master-vanilla
cp $LIBMOUNT_MTAB $TS_OUTPUT	# save the mtab aside
ts_finalize_subtest		# checks the mtab

ts_init_subtest "mtab-umount"
<<<<<<< HEAD
$TESTPROG --remove /mnt/bar
$TESTPROG --remove /mnt/gogo
$TESTPROG --remove /proc
=======
ts_valgrind $TESTPROG --remove /mnt/bar
ts_valgrind $TESTPROG --remove /mnt/gogo
ts_valgrind $TESTPROG --remove /proc
>>>>>>> master-vanilla
cp $LIBMOUNT_MTAB $TS_OUTPUT	# save the mtab aside
ts_finalize_subtest		# checks the mtab

#
# utab
#
rm -f $LIBMOUNT_MTAB
ln -s /proc/mounts $LIBMOUNT_MTAB

export LIBMOUNT_UTAB=$TS_OUTPUT.utab
rm -f $LIBMOUNT_UTAB
> $LIBMOUNT_UTAB

ts_init_subtest "utab-mount"
<<<<<<< HEAD
$TESTPROG --add /dev/sda1 /mnt/foo ext3 "rw,bbb,ccc,fff=FFF,ddd,noexec"
$TESTPROG --add /dev/sdb1 /mnt/bar ext3 "ro,user"
$TESTPROG --add /dev/sda2 /mnt/xyz ext3 "rw,loop=/dev/loop0,uhelper=hal"
$TESTPROG --add none /proc proc "rw,user"
=======
ts_valgrind $TESTPROG --add /dev/sda1 /mnt/foo ext3 "rw,bbb,ccc,fff=FFF,ddd,noexec"
ts_valgrind $TESTPROG --add /dev/sdb1 /mnt/bar ext3 "ro,user"
ts_valgrind $TESTPROG --add /dev/sda2 /mnt/xyz ext3 "rw,loop=/dev/loop0,uhelper=hal"
ts_valgrind $TESTPROG --add none /proc proc "rw,user"
>>>>>>> master-vanilla
cp $LIBMOUNT_UTAB $TS_OUTPUT	# save the mtab aside
ts_finalize_subtest		# checks the mtab

ts_init_subtest "utab-move"
<<<<<<< HEAD
$TESTPROG --move /mnt/bar /mnt/newbar
$TESTPROG --move /mnt/xyz /mnt/newxyz
=======
ts_valgrind $TESTPROG --move /mnt/bar /mnt/newbar
ts_valgrind $TESTPROG --move /mnt/xyz /mnt/newxyz
>>>>>>> master-vanilla
cp $LIBMOUNT_UTAB $TS_OUTPUT	# save the mtab aside
ts_finalize_subtest		# checks the mtab

ts_init_subtest "utab-remount"
<<<<<<< HEAD
$TESTPROG --remount /mnt/newbar "ro,noatime"
$TESTPROG --remount /mnt/newxyz "rw,user"
=======
ts_valgrind $TESTPROG --remount /mnt/newbar "ro,noatime"
ts_valgrind $TESTPROG --remount /mnt/newxyz "rw,user"
>>>>>>> master-vanilla
cp $LIBMOUNT_UTAB $TS_OUTPUT	# save the mtab aside
ts_finalize_subtest		# checks the mtab

ts_init_subtest "utab-umount"
<<<<<<< HEAD
$TESTPROG --remove /mnt/newbar
$TESTPROG --remove /proc
cp $LIBMOUNT_UTAB $TS_OUTPUT	# save the mtab aside
ts_finalize_subtest		# checks the mtab

=======
ts_valgrind $TESTPROG --remove /mnt/newbar
ts_valgrind $TESTPROG --remove /proc
cp $LIBMOUNT_UTAB $TS_OUTPUT	# save the mtab aside
ts_finalize_subtest		# checks the mtab

#
# fstab - replace
#
export LIBMOUNT_FSTAB=$TS_OUTPUT.fstab
rm -f $LIBMOUNT_FSTAB
cp "$TS_SELF/files/fstab.comment" $LIBMOUNT_FSTAB

ts_init_subtest "fstab-replace"
ts_valgrind $TESTPROG --replace "LABEL=foo" "/mnt/foo"
cp $LIBMOUNT_FSTAB $TS_OUTPUT	# save the fstab aside
ts_finalize_subtest		#checks the fstab

>>>>>>> master-vanilla
ts_finalize
